<div class="wrapper">
    <input type="hidden" class="tabstoggle" name="attr_sheetTab" value="pilot"/>
    <div>
        <button type="action" name="act_pilot" class="tabs">Character</button>
        <button type="action" name="act_info" class="tabs">Info</button>
        <button type="action" name="act_inv" class="tabs">Gear</button>
    </div>
    <div class="info">
        <h2>Information</h2>
        <div class="grid">
            <div class="col">
                <label>Name </label>
                <input class="colInput" type="text" name="attr_character_name">
            </div>
            <div class="col">
                <label>Race </label>
                <input class="colInput" type="text" name="attr_race">
            </div>
            <div class="col">
                <label>Class </label>
                <input class="colInput" type="text" name="attr_class">
            </div>
            <div class="col">
                <label>City of Origin </label>
                <input class="colInput" type="text" name="attr_coo">
            </div>
            <div class="col">
                <label>Age </label>
                <input class="colInput" type="text" name="attr_age">
            </div>
            <div class="col">
                <label>Height </label>
                <input class="colInput" type="text" name="attr_height">
            </div>
            <div class="col">
                <label>Weight </label>
                <input class="colInput" type="text" name="attr_weight">
            </div>
            <div class="col">
                <label>Language </label>
                <input class="colInput" type="text" name="attr_lang">
            </div>
            <div class="col">
                <label>Notes </label>
                <textarea class="colInput" name="attr_notes">
            </div>
        </div>
    </div>
    <div class="pilot">
        <div class="tabstoggle">
            <h2></button> D20 <button type="roll" value="[[1d20]]"></button>High <button type="roll" value="&{template:rollhigh}{{name=@{character_name}}}{{roll=[[1d20]]}}"></button> or Low <button type="roll" value="&{template:rolllow}{{name=@{character_name}}}{{roll=[[1d20]]}}"></h2>
        </div>
        <div class="twocolumns">
            <div>
                
                <div class="twocolumns">
                    <div class="labels">
                        <h2 title="All stats cost 5 points.">Stats</h2>
                    </div>
                </div>
                <div class="twocolumns">
                    <div class="labels">
                        <label title="Tuf, starts at 5, cost 5 CP. +1 HP. Defense, life saves / Afflictions (poison, drowning, etc.).">Toughness </label>
                        <label title="Str, starts at 5, cost 5 CP. +1 HP. Melee Attack bonus Damage, Melee techniques, lifting, arm wrestling etc., and Inventory slots (if used).">Strength </label>
                        <label title="Fin, starts at 5, cost 5 CP. +1 HP +1 E. Charisma & Dexterity combined. Art, dancing, music, smooth-talking, etc., & delicacy, stealth, evasion, traversal, sleight-of-hand, etc.">Finesse </label>
                        <label title="Pow, starts at 5, cost 5 CP. +1 E. Used for casting S&Es.">Power </label>
                        <label title="IQ, starts at 5, cost 5 CP. +1 E. Puzzles, perception, knowledge, decision-making, detection, etc.">Intelligence </label>
                    </div>
                    <div class="valuecolumn">
                        <input title="Toughness" type="number" min="0" name="attr_tuf" value="5">
                        <input title="Strength" min="0" type="number" name="attr_str" value="5">
                        <input title="Finesse" type="number" min="0" name="attr_dx" value="5">
                        <input title="Power" min="0" type="number" name="attr_pow" value="5">
                        <input title="Intelligence" type="number" min="0" name="attr_iq" value="5">
                    </div>
                    <div class="valuecolumn">
                        <button style="height: 18px;" type="roll" title="Roll Toughness." value="&{template:roll}{{name=@{character_name}}}{{total=[[ [[1d20]] + @{tuf}[Tuf] ]]}}{{roll=$[[0]]}}{{stat='Toughness'}}"></button>
                        <button style="height: 18px;" type="roll" title="Roll Strength." value="&{template:roll}{{name=@{character_name}}}{{total=[[ [[1d20]] + @{str}[Str] ]]}}{{roll=$[[0]]}}{{stat='Strength'}}"></button>
                        <button style="height: 18px;" type="roll" title="Roll Finesse." value="&{template:roll}{{name=@{character_name}}}{{total=[[ [[1d20]] + @{dx}[Fin] ]]}}{{roll=$[[0]]}}{{stat='Finesse'}}"></button>
                        <button style="height: 18px;" type="roll" title="Roll Power." value="&{template:roll}{{name=@{character_name}}}{{total=[[ [[1d20]] + @{pow}[Pow] ]]}}{{roll=$[[0]]}}{{stat='Power'}}"></button>
                        <button style="height: 18px;" type="roll" title="Roll Intelligence." value="&{template:roll}{{name=@{character_name}}}{{total=[[ [[1d20]] + @{iq}[IQ] ]]}}{{roll=$[[0]]}}{{stat='Intelligence'}}"></button>
                    </div>
                    <div class="valuecolumn">
                        <button style="height: 18px; color: orange;" type="roll" title="Roll Toughness with mods." value="&{template:roll}{{name=@{character_name}}}{{total=[[ [[1d20]] + ?{Modifier?|0}[Mod] + @{tuf}[Tuf] ]]}}{{roll=$[[0]]}}{{stat='Toughness'}}"></button>
                        <button style="height: 18px; color: orange;" type="roll" title="Roll Strength with mods." value="&{template:roll}{{name=@{character_name}}}{{total=[[ [[1d20]] + ?{Modifier?|0}[Mod] + @{str}[Str] ]]}}{{roll=$[[0]]}}{{stat='Strength'}}"></button>
                        <button style="height: 18px; color: orange;" type="roll" title="Roll Finesse with mods." value="&{template:roll}{{name=@{character_name}}}{{total=[[ [[1d20]] + ?{Modifier?|0}[Mod] + @{dx}[Fin] ]]}}{{roll=$[[0]]}}{{stat='Finesse'}}"></button>
                        <button style="height: 18px; color: orange;" type="roll" title="Roll Power with mods." value="&{template:roll}{{name=@{character_name}}}{{total=[[ [[1d20]] + ?{Modifier?|0}[Mod] + @{pow}[Pow] ]]}}{{roll=$[[0]]}}{{stat='Power'}}"></button>
                        <button style="height: 18px; color: orange;" type="roll" title="Roll Intelligence with mods." value="&{template:roll}{{name=@{character_name}}}{{total=[[ [[1d20]] + ?{Modifier?|0}[Mod] + @{iq}[MR] ]]}}{{roll=$[[0]]}}{{stat='Intelligence'}}"></button>
                    </div>
                </div>
            </div>
            <div style="margin-left: 50px;">
                <h2 title="HP & E cost 1 CP each.">Trackers</h2>
                <div class="twocolumns">
                    <div class="labels">
                        <label title="HP / Max. Your avaialble & Max HP. Tuf, Str, and Fin give +1. When HP reaches 0, you pass out.">Hit Points </label>
                        <label title="1 CP. Adds to Max HP.">HP Bonus </label>
                        <label title="E / Max. Your avaialble & Max E. Pow, Iq, and Fin give +1. E is used for Abilities & Overdrive.">Energy </label>
                        <label title="1 CP. Adds to Max E">E Bonus </label>
                    </div>
                    <div class="valuecolumn">
                        <div><input type="number" min="0" name="attr_hp" value="10">/</div>
                        <input type="number" min="0" name="attr_hpmax" value="0">
                        <div><input type="number" min="0" name="attr_e" value="10">/</div>
                        <input type="number" min="0" name="attr_emax" value="0">
                    </div>
                    <div class="valuecolumn">
                        <input type="number" disabled name="attr_hp_max" title="HP Max" value="((@{dx}) + (@{str}) + (@{tuf}) + (@{hpmax}))">
                        <button title="Restore HP to Max HP" type="action" name="act_restore_hp" style="height: 20px;">Rest HP</button>
                        <input type="number" disabled name="attr_e_max" title="E Max" value="((@{emax}) + (@{pow}) + (@{dx}) + (@{iq}))">
                        <button title="Restore E to Max E" type="action" name="act_restore_e" style="height: 20px;">Rest E</button>
                    </div>
                </div>

            </div>
            <div style="margin-left: 50px;">
                <h2>Points</h2>
                <div class="twocolumns">
                    <div class="labels">
                        <label title="The points awarded to you by the GM">Total Worth </label>
                        <label title="Total points you have spent">Spent </label>
                        <label title="The remaining points" style="color: chartreuse;">Available </label>
                        <label title="Stats (5 CP each) & Utility (1 CP each)">Stats </label>
                        <label title="Damage & Accuracy (2 CP each).">Attacks </label>
                        <label title="AP (1 CP) & Damage (2 CP)">Spells </label>
                        <label title="The points you have spent on Passives">Perks/Flaws </label>
                    </div>
                    <div class="valuecolumn">
                        <input type="number" name="attr_tw" value="100" style="width: 100px;">
                        <input type="number" disabled name="attr_totalspent" title="Spent" value="((@{stats}) + (@{passives}) + (@{dmgc}) + (@{spells}))" class="x">
                        <input type="number" style="color: lime;" disabled name="attr_avail" title="Available" value="((@{tw})-(@{totalspent}))" class="x">
                        <input type="number" disabled name="attr_stats" title="Stats" value="(((@{tuf})-5)*5 + ((@{dx})-5)*5  + ((@{iq})-5)*5  + ((@{str})-5)*5  + ((@{pow})-5)*5 + (@{emax}) + (@{hpmax}))" class="x">
                        <input type="hidden" name="attr_foo_dmgc" value="0" class="x">
                        <input type="hidden" name="attr_foo_spells" value="0" class="x">
                        <input type="hidden" name="attr_foo_passives" value="0" class="x">
                        <input type="number" disabled name="attr_dmgc" title="Dmg" value="@{foo_dmgc}" class="x">
                        <input type="number" disabled name="attr_spells" title="Abilities" value="@{foo_spells}" class="x">
                        <input type="number" disabled name="attr_passives" title="Passives" value="@{foo_passives}" class="x">
                    </div>
                </div>
            </div>
        </div>

        <div class="sheet-rolltemplate-spacer"></div>

        <h3 title="Attacks only do Dmg, but can be combined with S&Es">Attacks</h3>
        <div class="weapon">
            <label style="width: 200px">Name</label>
            <label style="width: 40px; color: red;" title="2 CP. Increses Dice total of Attack (1 Die / 10 rounded up).">Dmg</label>
            <label style="width: 40px" title="Accuracy, 2 CP. Any penalty <= succeeds automatically. Leftover Acc reduces Tuf of target.">Acc</label>
            <label style="width: 63px" title="If Melee, add Str to Dmg. If Ranged, add Fin to Acc">Melee</label>
            <label style="width: 95px;" title="Paid for Accuracy plus Finesse if Ranged.">Tot Acc</label>
            <label style="width: 95px; color: red;" title="Roll Dice for Dmg. If unchecked, you deal half total (rounded down) as Dmg - no roll.">Dmg Dice</label>
            <label style="width: 36px" title="Use Attack with or without Mods.">Roll</label>
            <label style="width: 80px;" title="Attacks can be added to a Spell for Dmg.">Combine to Effects</label>
        </div>
        <div>
            <fieldset class="repeating_attacks">
                <div class="weapon">
                    <input type="hidden" name="attr_foo_roll" value="[[0]]">
                    <input type="hidden" name="attr_foo_dmgroll" value="0">
                    <input type="hidden" name="attr_totdmg" value="0">
                    <input type="hidden" name="attr_foo_totacc" value="0">

                    <input type="text" name="attr_atkname">
                    <input style="color:rgb(102, 0, 0);" type="number" min="0" name="attr_bdmg" value="0">
                    <input type="number" min="0" name="attr_range" value="0">
                    <select name="attr_melee" style="width: 80px;">
                        <option value="@{str}" selected="selected">Melee</option>
                        <option value="0">Range</option>
                    </select>
                    <input style="width: 90px;" type="number" disabled name="attr_totacc" value="@{foo_totacc}">
                    <input type="checkbox" name="attr_useroll" value="1" checked>
                    <input style="width: 90px;" type="text" disabled name="attr_dmgroll" value="@{foo_dmgroll}">
                    <button style="height: 24px;" type="roll" title="Use Attack" value="&{template:weapondmg}{{name=@{character_name}}}{{atkname=@{atkname}}}{{dmg=@{foo_roll}}}{{max=[[@{totdmg}]]}}{{acc=[[@{totacc}]]}}"></button>
                    <button style="height: 24px; color: orange;" type="roll" title="Use Attack with Mods" value="&{template:weapon}{{name=@{character_name}}}{{atkname=@{atkname}}}{{total=[[ [[1d20]] + @{totacc}[Acc] ]]}}{{roll=$[[0]]}}{{diff=[[?{Hit Mod?|0}[Mod]]]}}{{dmg=@{foo_roll}}}{{max=[[@{totdmg}]]}}"></button>
                    &emsp;&emsp;
                    <input type="checkbox" name="attr_combo" value="1">
                </div>
            </fieldset>
        </div>

        <br>
        <div class="sheet-rolltemplate-spacer"></div>

        <h3 title="S&Es roll Pow vs AP for success, and must beat targets Tuf to not be resisted. S&E can combine with an Attack. A Failed attempt still deals Dmg.">Spells & Effects</h3>
        <input type="hidden" name="attr_atkdmg" value="0">
        <input type="hidden" name="attr_atkacc" value="0">

        <div class="weapon">
            <label style="width: 170px;">Name</label>
            <label style="width: 190px" title="The 1 Effect for this Spell. Include Duration unit if not 5 Rounds.">Effect</label>
            <label style="width: 40px" title="If checked, adds Power to Damamge. Otherwise uses Power for Accuracy.">Pow Dmg</label>
            <label style="width: 30px; color: blue;" title="Ability Power, 1 CP. Mark for success & E cost of the Effect, and is also the limit for Affliction Dmg.">AP</label>
            <label style="width: 110px; color: red;" title="Dmg + Attack Max Dmg (if selected). If unchecked, use half total (rounded down) as Dmg - no roll">Dmg Dice</label>
            <label style="width: 36px" title="Use the Effect with or without Mods.">Use</label>
            <label style="width: 60px;color:green;" title="The percent chance of landing this Effect.">Success %</label>
        </div>
        <div>
            <fieldset class="repeating_spells">
                <div class="weapon">
                    <input type="hidden" name="attr_foo_success" value="95%">
                    <input type="hidden" name="attr_foo_roll" value="[[0]]">
                    <input type="hidden" name="attr_foo_dmgroll" value="0">
                    <input type="hidden" name="attr_powacc" value="0">

                    <input type="text" name="attr_atkname">
                    <textarea type="text" name="attr_ability"></textarea>
                    &emsp;<input type="checkbox" name="attr_powdmg">&emsp;
                    <input style="color:blue;" type="number" min="1" name="attr_adc" value="1">
                    <input type="checkbox" name="attr_useroll" value="1" checked>
                    <input style="width: 90px;" type="text" disabled name="attr_dmgroll" value="@{foo_dmgroll}">
                    <button style="height: 24px;" type="roll" title="Use the Effect" value="&{template:spell}{{name=@{character_name}}}{{atkname=@{atkname}}}{{total=[[ [[1d20]]+ @{powacc}[Pow] ]]}}{{pen=[[@{adc}]]-$[[1.computed]]}}{{roll=$[[0]]}}{{cost=[[@{adc}]]}}{{diff=[[@{adc}]]}}{{ability=@{ability}}}{{dmg=@{foo_roll}}}"></button>
                    <button style="height: 24px; color: orange;" type="roll" title="Use the Effect with Mods" value="&{template:spell}{{name=@{character_name}}}{{atkname=@{atkname}}}{{total=[[ [[1d20]] + @{powacc}[Pow] + @{atkacc}[acc] ]]}}{{pen=[[@{adc}[AP] + ?{Hit Mod?|0}[Mod]]]-$[[1.computed]]}}{{roll=$[[0]]}}{{cost=[[@{adc}]]}}{{diff=[[@{adc}[AP] + ?{Hit Mod?|0}[Mod]]]}}{{ability=@{ability}}}{{dmg=@{foo_roll}}}"></button>
                    <input style="color:green; width: 90px;" type="text" disabled name="attr_success" title="Success %" value="@{foo_success}" class="x">
                </div>
            </fieldset>
        </div>

        <br>
        <div class="sheet-rolltemplate-spacer"></div>

        <h3 title="Things that make you special. S&Es are different from Perks in 4 ways: S&Es only last a certain time, always cost E, success is based on Pow roll, and always take 1 Action. Flaws are negative Perks (use -CP) that earn you points">Perks & Flaws</h3>
        <div class="weapon">
            <label style="width: 170px;">Name</label>
            <label style="width: 190px;" title="Makes sure to put all details in this box (length, bonus, rolls, all of it)">Description</label>
            <label>CP</label>
        </div>
        <fieldset class="repeating_passives">
            <div class="weapon">
                <input type="text" name="attr_abilname" title="Name of the ability"><textarea name="attr_ability"></textarea> <input type="number" name="attr_passcp" title="+ for advantage, - for disadvantage">
            </div>
        </fieldset>
    </div>

    <div class="inv">
        <h2>Gear</h2>
        Silver<input type="number" style="width: 80px;" step=".01" name="attr_gold" value="100">
        <div class="weapon">
            <label>Name</label>
            <label>Description</label>
            <label style="width: 35px;">#</label>
            <label style="width: 35px;">Slots</label>
            <label>Cost</label>
        </div>
        <div>
            <fieldset class="repeating_items">
                <div class="weapon">
                    <input type="text" name="attr_itemname" title="Name of the Item">
                    <input type="text" name="attr_itemdescr" title="Description">
                    <input type="number" name="attr_quantity" title="Number of this item you have. Most items can't have more than 10 in a slot.">
                    <input type="number" name="attr_slots" title="items don't have a weight, just a slot count. Most items take 1 slot">
                    <input type="number" name="attr_itemcost" title="The amount in silver the item costs">
                </div>
            </fieldset>
        </div>
        <div>
            <input type="hidden" name="attr_foo_slotsused" value="0">
            Slots used: <input name="attr_slotsused" type="number" disabled value="@{foo_slotsused}"> Slots available: <input type="number" name="attr_slotsavail" disabled value="((@{str})*2-(@{foo_slotsused})+10)">
        </div>
    </div>
</div>


<script type="text/worker">

    ["pilot","info","grim","inv"].forEach(button => {
        on(`clicked:${button}`, function() {
            setAttrs({
                "sheetTab": button
            });
        });
    });

    on('clicked:restore_e', function() {
        getAttrs( ["emax", "dx", "iq", "pow"]
        , function(values) {
            setAttrs({"e": (parseInt(values.emax) + parseInt(values.dx||0) + parseInt(values.iq||0) + parseInt(values.pow||0))}
            , {silent:true}
            );
        });
    });

    on('clicked:restore_hp', updateHP_MAX);

    function updateHP_MAX(){
        getAttrs( ["hpmax", "tuf", "dx", "str"],
            function(values) {
                setAttrs({"hp":(parseInt(values.hpmax||0) + parseInt(values.tuf||0) + parseInt(values.dx||0) + parseInt(values.str||0))}
                , {silent:true}
                );
            });
    }
    
    on("change:repeating_spells:adc remove:repeating_spells", function(eventInfo) {
        getRepeatingFields("repeating_spells", ["adc"], function(fieldValues){
                    setAttrs({
                    "foo_spells": sumFieldValues(fieldValues)
                }, {silent:true});
        });
    });
    
    on("change:repeating_attacks:range change:repeating_attacks:bdmg remove:repeating_attacks", function(eventInfo) {
        getRepeatingFields("repeating_attacks", ["bdmg", "range"], function(fieldValues){
                    setAttrs({
                "foo_dmgc": sumFieldValues(fieldValues)*2
            }, {silent:true});
        });
    });

    on("change:repeating_items:slots remove:repeating_items", function(eventInfo) {
        getRepeatingFields("repeating_items", ["slots"], function(fieldValues){
                    setAttrs({
                  "foo_slotsused": sumFieldValues(fieldValues)
              });
          });
      });
      
    on("change:repeating_passives:passcp remove:repeating_passives", function(eventInfo) {
        getRepeatingFields("repeating_passives", ["passcp"], function(fieldValues){
                    setAttrs({
                  "foo_passives": sumFieldValues(fieldValues)
              });
          });
      });

    function sumFieldValues(fieldValues){
        var sum = 0;
        Object.values(fieldValues).forEach(element => sum += parseInt(element)||0);
        return sum;
    }
    
	function getRepeatingFields(sectionName, fieldNames, callback) {
		getSectionIDs(sectionName, function (ids) {
			if (ids.length === 0) {
				callback(0);
				return;
			}
			var fieldArray = [];
            for (var j = 0; j < fieldNames.length; j++) {
                for (var i = 0; i < ids.length; i++) {
                    fieldArray.push(sectionName + '_' + ids[i] + '_' + fieldNames[j]);
                }
            }
			getAttrs(fieldArray, function (fieldValues) {
				callback(fieldValues);
			});
		});
	}

    on('change:emax change:pow change:iq change:dx' , function(eventInfo) {
        getAttrs( ["e"]
        , function(values) {
                    setAttrs({"e": Math.max(0,(parseInt(values.e) + (parseInt(eventInfo.newValue) - (parseInt(eventInfo.previousValue)||0))))}, {silent:true});
        });
    });

    on("change:hpmax change:tuf change:dx change:str", function(eventInfo) {
        getAttrs( ["hp"]
        , function(values) {
                    setAttrs({
                "hp": (parseInt(values.hp) + (parseInt(eventInfo.newValue) - (parseInt(eventInfo.previousValue)||0)))}, {silent:true}
            );
        });
    });

    function calculateChance(dc, subtractStat){
        return Math.trunc(100*Math.min(.95, Math.max(0, (21 - Math.max(0, dc - subtractStat)))/20));
    }

    on("change:str change:dx change:pow", function(eventInfo) {
        getAttrs(
            ["pow", "str", "dx"]
        , function(values) {
            var sendValues = {};
            getRepeatingFields("repeating_attacks", ["melee", "bdmg", "useroll", "range", "combo" ]
            , function(fieldValues2){
                var incomingAtk;
                var noCombo = true;
                for(const property2 in fieldValues2){
                    if(property2[property2.length - 1] == 'l'){
                        incomingAtk = property2.substring(0, property2.lastIndexOf("_"));
                        var totdmg = parseInt(fieldValues2[incomingAtk + "_bdmg"]);
                        var totacc = parseInt(fieldValues2[incomingAtk + "_range"]);
                        if(fieldValues2[incomingAtk + "_melee"] == "@{str}")
                            totdmg += parseInt(values.str);
                        else
                            totacc += parseInt(values.dx);
                        sendValues[incomingAtk + "_totdmg"] = totdmg;
                        fillDmgRoll(fieldValues2[incomingAtk + "_useroll"], incomingAtk, totdmg, sendValues);
                        if(fieldValues2[incomingAtk + "_combo"] == "1"){
                            values.atkdmg = sendValues.atkdmg = totdmg;
                            values.atkacc = sendValues.atkacc = totacc;
                            noCombo = false;
                        }
                    }
                }
                if(noCombo){
                        values.atkdmg = 0;
                        values.atkacc = 0;
                }
                getRepeatingFields("repeating_spells", ["adc", "powdmg", "useroll", "powacc"], function(fieldValues){
                    for(const property in fieldValues){
                        if(property[property.length - 1] == 'c'){
                            incomingAtk = property.substring(0, property.lastIndexOf("_"));
                            updateSpellWithAtk(values, sendValues, incomingAtk, fieldValues);
                        }
                    }
                    setAttrs(sendValues,{silent:true});
                });
            });
        });
    });

    function getRollForDmg(f){
        if(f == 0)
            return "0";
        var tens = Math.ceil(f/10);
        var die = f/tens;
        if(Number.isInteger(die)){
            return String(tens) + "d" + String(die);
        }else{
            return String(tens-1) + "d" + String(Math.floor(die)) + "+1d" + String(Math.floor(die) + (f%tens));
        }
    }

    function addBrackets(val){
        return "[[" + String(val) + "]]"
    }

    function fillDmgRoll(useRoll, incomingAtk, dmg, sendValues){
        if(useRoll == "0"){
            if(dmg == 0 || dmg == 1){
                sendValues[incomingAtk + "_foo_roll"] =addBrackets(dmg);
                sendValues[incomingAtk + "_foo_dmgroll"] = dmg;
            }else {
                var halfDmg = Math.floor(dmg/2);
                sendValues[incomingAtk + "_foo_roll"] =addBrackets(halfDmg);
                sendValues[incomingAtk + "_foo_dmgroll"] = halfDmg;
            }
        }else{
            var roll = getRollForDmg(dmg);
            sendValues[incomingAtk + "_foo_roll"] = addBrackets(roll);
            roll = roll.replaceAll("d", "(d");
            var indOfPlus = roll.indexOf("+");
            if(indOfPlus != -1){
                roll = roll.substring(0, indOfPlus) + ")" + roll.substring(indOfPlus);
            }
            if(roll != "0")
                roll = roll + ")";
            sendValues[incomingAtk + "_foo_dmgroll"] = roll;
        }
    }
    
    on("change:repeating_attacks", function(eventInfo) {
        var incomingAtk = eventInfo.triggerName;
        if(incomingAtk == "repeating_attacks_melee")
            return;
        getAttrs(
            [incomingAtk + "_melee", incomingAtk + "_range", incomingAtk + "_bdmg", incomingAtk + "_useroll", incomingAtk + "_combo"
            , "pow", "str", "atkdmg", "atkacc", "dx"]
        , function(values) {
            var sendValues = {};
            var totdmg = parseInt(values[incomingAtk + "_bdmg"]);
            var totacc = parseInt(values[incomingAtk + "_range"]);
            if(values[incomingAtk + "_melee"] == "@{str}")
                totdmg += parseInt(values.str);
            else
                totacc += parseInt(values.dx);
            sendValues[incomingAtk + "_totdmg"] = totdmg;
            sendValues[incomingAtk + "_foo_totacc"] = totacc;
            fillDmgRoll(values[incomingAtk + "_useroll"], incomingAtk, totdmg, sendValues);
            if(values[incomingAtk + "_combo"] == "1"){
                values.atkdmg = sendValues.atkdmg = totdmg;
                values.atkacc = sendValues.atkacc = totacc;
            }else if(eventInfo.sourceAttribute[eventInfo.sourceAttribute.length-1] == "o"){
                values.atkdmg = sendValues.atkdmg = 0;
                values.atkacc = sendValues.atkacc = 0;
            }
            getRepeatingFields("repeating_spells", ["adc", "powdmg", "useroll", "powacc"], function(fieldValues){
                for(const property in fieldValues){
                    if(property[property.length - 1] == 'c'){
                        incomingAtk = property.substring(0, property.lastIndexOf("_"));
                        updateSpellWithAtk(values, sendValues, incomingAtk, fieldValues);
                    }
                }
                    setAttrs( sendValues , {silent:true} );
            });
        });
    });
    
    on("change:repeating_attacks:combo", function(eventInfo) {
        var sendValues = {};
        getRepeatingFields("repeating_attacks", ["combo"], function(fieldValues){
            for(const property in fieldValues){
                sendValues[property] = 0;
            }
            sendValues[eventInfo.sourceAttribute] = eventInfo.newValue;
                    setAttrs( sendValues , {silent:true} );
        });
    });

    function updateSpellWithAtk(values, sendValues, incomingAtk, fieldValues){
        var totdmg = parseInt(values.atkdmg);
        var totacc = 0;
        if(fieldValues[incomingAtk + "_powdmg"] == "on")
            totdmg += parseInt(values.pow);
        else
            totacc += parseInt(values.pow);
        sendValues[incomingAtk + "_powacc"] = totacc;
        fillDmgRoll(fieldValues[incomingAtk + "_useroll"], incomingAtk, totdmg, sendValues);
        setSuccess(sendValues, incomingAtk, parseInt(fieldValues[incomingAtk + "_adc"]), totacc);
    }
    
    on("change:repeating_spells", function(eventInfo) {
        var sendValues = {};
        const incomingAtk = eventInfo.triggerName;
            getAttrs(
                [incomingAtk + "_adc", "atkdmg", "pow", incomingAtk + "_powdmg", incomingAtk + "_useroll", incomingAtk + "_powacc"]
            , function(values) {
                updateSpellWithAtk(values, sendValues, incomingAtk, values);
                    setAttrs( sendValues , {silent:true} );
            });
    });

    function setSuccess(sendValues, incomingAtk, diff, pow){
        sendValues[incomingAtk + "_foo_success"] = String(calculateChance(diff, pow)) + "% ";
    }

    on("sheet:opened", function(eventInfo){
        getAttrs([
            "first"
        ]
        , function(values) {
            if(values.first == undefined){
                setAttrs({
                    "tuf": 5
                    ,"iq":5
                    ,"dx":5
                    ,"str":5
                    ,"pow":5
                    ,"hpmax":0
                    ,"hp":5
                    ,"first":1
                    ,"atkdmg":0
                    ,"e":5
                    ,"emax":0
                    ,"gold":100
                    ,"foo_passives":0
                    ,"foo_dmgc":0
                }
                , {silent:true}
                );
            }
            updateHP_MAX();
        });
    });
</script>

<rolltemplate class="sheet-rolltemplate-roll">
    <table>
        <tr>
            <th>
                {{name}} rolls {{stat}}:
            </th>
        </tr>
        <tr>
            <td>
                <div class="sheet-rolltemplate-spacer"></div>
            </td>
        </tr>
        <tr>
            <td>
                {{#rollTotal() roll 20}}
                <strong style="color: green;">CRIT SUCCESS!</strong> ({{roll}}) (total = {{total}}) <br>
                You succeed, and get really lucky! Optionally you can gamble with a high or low. Success means you Double Crit. Fail means you just succeed.
                {{/rollTotal() roll 20}}

                {{#rollBetween() roll 2 19}}
                <strong>{{total}}</strong>
                {{/rollBetween() roll 2 19}}

                {{#rollTotal() roll 1}}
                <strong style="color: red;">CRIT FAIL!</strong> ({{roll}}) (total = {{total}})<br>
                Succeed a "high or low" or something bad happens
                {{/rollTotal() roll 1}}
            </td>
        </tr>
    </table>
</rolltemplate>

<rolltemplate class="sheet-rolltemplate-weapon">
    <table>
        <tr>
            <th>
                {{name}} attacks with {{atkname}}
            </th>
        </tr>
        <tr>
            <td>
                <div class="sheet-rolltemplate-spacer"></div>
            </td>
        </tr>
        <tr>
            <td>
                {{#rollWasCrit() roll}}
                <strong style="color: green;">CRIT SUCCESS!</strong> ({{roll}}) (total = {{total}})
                <br>
                Double Dmg {{dmg}} + {{dmg}}, or ignore target's Tuf.
                <br>
                May Spend E to increase this up to Max Dmg {{max}} (Overdrive) before doubling.
                {{/rollWasCrit() roll}}

                {{#rollWasFumble() roll}}
                <strong style="color: red;">CRIT FAIL!</strong> ({{roll}}) (total = {{total}})
                <br>
                Succeed a "high or low" or drop your weapon or fall prone.
                {{/rollWasFumble() roll}}


                {{#rollBetween() roll 2 19}}

                {{#rollLess() total diff}}
                {{total}} is a <strong style="color: red;">Fail...</strong> Mark: {{diff}}
                <br>
                Spend E (Overdrive) to succeed for Dmg: {{dmg}}
                <br>
                <i>(Lose Hit location, may NOT raise Dmg with Overdrive)</i>

                {{/rollLess() total diff}}

                {{#^rollLess() total diff}}
                {{total}} is a <strong style="color: green;">Success!</strong> Mark: {{diff}}
                <br>
                Dmg: {{dmg}}. May Spend E to increase this up to Max Dmg {{max}} (Overdrive).
                {{/^rollLess() total diff}}

                {{/rollBetween() roll 2 19}}

            </td>
        </tr>
    </table>
</rolltemplate>

<rolltemplate class="sheet-rolltemplate-weapondmg">
    <table>
        <tr>
            <th>
                {{name}} attacks with {{atkname}}
            </th>
        </tr>
        <tr>
            <td>
                <div class="sheet-rolltemplate-spacer"></div>
            </td>
        </tr>
        <tr>
            <td>
                {{#rollTotal() dmg max}}
                <strong style="color: green;">CRIT SUCCESS!</strong> {{dmg}}<br>
                You did Max Dmg. Roll Dmg Again for "Carry Over".
                {{/rollTotal() dmg max}}

                {{#^rollTotal() dmg max}}
                {{dmg}}<strong style="color: maroon;"> Dmg</strong>. May Spend E to increase this up to Max Dmg {{max}} (Overdrive).
                {{/^rollTotal() dmg max}}
                <br>
                Subtract leftover Acc ({{acc}}) from target's Tuf.
            </td>
        </tr>
    </table>
</rolltemplate>

<rolltemplate class="sheet-rolltemplate-spell">
    <table>
        <tr>
            <th>
                {{name}} uses S&E {{atkname}}
            </th>
        </tr>
        <tr>
            <td>
                <div class="sheet-rolltemplate-spacer"></div>
            </td>
        </tr>
        <tr>
            <td>
                {{#rollWasCrit() roll}}
                <strong style="color: green;">CRIT SUCCESS!</strong> ({{roll}}) (total = {{total}})<br>
                Your attack auto hits. Double Effect or Dmg. No E cost.
                {{#^rollTotal() dmg 0}}
                <br>
                <strong style="color: maroon;">Dmg:</strong> {{dmg}}.
                {{/^rollTotal() dmg 0}}
                <div class="sheet-rolltemplate-spacer"></div>
                <strong>Effect:</strong><br>{{ability}}
                {{/rollWasCrit() roll}}

                {{#rollWasFumble() roll}}
                <strong style="color: red;">CRIT FAIL!</strong> ({{roll}}) (total = {{total}})
                <br>
                Your attack auto fails. Succeed a "high or low" or Effect goes wrong.
                <br>
                Subtract {{cost}} E.
                {{/rollWasFumble() roll}}

                {{#rollBetween() roll 2 19}}

                {{#rollLess() total diff}}
                {{total}} is a <strong style="color: red;">Fail...</strong> Mark: {{diff}}<br>
                Spend {{pen}} E (Overdrive) to succeed<br>
                (Must pay for Effect before using overdrive)
                {{/rollLess() total diff}}

                {{#^rollLess() total diff}}
                {{total}} is a <strong style="color: green;">Success!</strong> Mark: {{diff}}
                {{/^rollLess() total diff}}
                
                <br>
                <strong style="color: blue;">E</strong> cost: {{cost}}.
                <div class="sheet-rolltemplate-spacer"></div>
                <strong>Effect:</strong><br>{{ability}}

                {{#^rollTotal() dmg 0}}
                <br>
                <strong style="color: red;">Dmg:</strong> {{dmg}}.
                {{/^rollTotal() dmg 0}}

                {{/rollBetween() roll 2 19}}
            </td>
        </tr>
    </table>
</rolltemplate>

<rolltemplate class="sheet-rolltemplate-rollhigh">
    <table>
        <tr>
            <th>
                {{name}} rolls for high!
            </th>
        </tr>
        <tr>
            <td>
                <div class="sheet-rolltemplate-spacer"></div>
            </td>
        </tr>
        <tr>
            <td>
                {{#rollBetween() roll 11 20}}
                <strong style="color: green;">Nailed It!</strong> ({{roll}})
                {{/rollBetween() roll 11 20}}

                {{#rollBetween() roll 1 10}}
                <strong style="color: red;">fail...</strong> ({{roll}})
                {{/rollBetween() roll 1 10}}
                <br>
                p.s. high/lows cannot crit
            </td>
        </tr>
    </table>
</rolltemplate>

<rolltemplate class="sheet-rolltemplate-rolllow">
    <table>
        <tr>
            <th>
                {{name}} rolls for low!
            </th>
        </tr>
        <tr>
            <td>
                <div class="sheet-rolltemplate-spacer"></div>
            </td>
        </tr>
        <tr>
            <td>
                {{#rollBetween() roll 11 20}}
                <strong style="color: red;">fail...</strong> ({{roll}})
                {{/rollBetween() roll 11 20}}

                {{#rollBetween() roll 1 10}}
                <strong style="color: green;">Nailed It!</strong> ({{roll}})
                {{/rollBetween() roll 1 10}}
                <br>
                p.s. high/lows cannot crit
            </td>
        </tr>
    </table>
</rolltemplate>